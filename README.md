# repeat

`repeat` is a java templating library that aims to be fast, reliable, lightweight, extensible.

## Download and dependecies

The only two runtime dependencies are `javassist` and `log4j`; building will require also `project lombok` and `junit`.

The build is done with the `maven` utility.

A prebuilt jar can be found under the `releases` section.

## Project overview

The classes in the `dgdevel.repeat.api` and sub-packages are considered stable.

To compile a template the needed stuff are a `Resolver` instance to retrive the source of the template in `String` form, a `Context` instance that will keep reference of all the generated templates, and invoke if needed the compiler, one or more `TokenHandler` instances that defines the syntax of the template.

A compiled `Template` instance will have two methods named `run`, that will take a `Map<String, Object>` of parameters named `params` and the output object named `out`, a `StringBuilder` or a `Writer`.

### Context

A `DefaultContext` class is provided under `dgdevel.repeat.impl`, even if it's not under the api package there will be made efforts to keep it stable.

### Resolvers

In the `dgdevel.repeat.predef.resolvers` can be found some useful `Resolver` implementation.

- `CascadeResolver`: it will receive a list of resolvers, and try them one after the other to get the sources

- `ClassLoaderResolver`: it will try to fetch the content of a resource via the `ClassLoader.getResourceAsStream` method

- `DirectoryResolver`: it will search in the specified directory for the named file

- `StringResolver`: it will keep only one template, name and source form, and return the source if that name is searched.

### TokenHandler

Under the `dgdevel.repeat.predef.tokenhandlers` package there are some useful implementation, to be used to extend the syntax.

Due to the parser simplicity they are evaluated in the order in which they appears, using only the prefix string. If an ambiguity arise the longest match takes precedence. For example defining both `<% .. %>` and `<%= .. %>` will match the latter. Then it will proceed on finding the closing tag, and if found it will call the `accept` method passing the content string; if it fails to accept a `ParseException` will be thrown.

### Presets

Three presets can be found under the `dgdevel.repeat.predef.syntax` package: a jsp like syntax, a mustache like syntax and a `repeat` specific language.

#### repeat lang

`repeat lang` contains a syntax to use more of the features of the java compiled language.

It offers a series of custom tags, here will be listed with the direct java translation. Note that to keep the ability of use the `>` sign in the expressions, a space is required at the end of tags that finish with an expression.

Declare a variable

`<declare type name expression >` → `<type> <name> = (<type>) expression;`

Get a parameter

`<getp type name param>` → `<type> <name> = (<type>) params.get(<param>);`

Set a parameter

`<setp name expression >` → `params.put(<name>,<expression>);`

If

`<if expression >` → `if (<expression>) {`

Else if

`<elseif expression >` → `} else if (<expression>) {`

Else

`<else>` → `} else {`

Closing parens

`<end>` → `}`

Comparison conditional

`<eq name1 name2>` → `if (<name1>.equals(<name2>)) {`

Loop over a collection

`<loopc type name index expression >` →
```
int <index> = -1;
for (Iterator <it> = (<expression>).iterator(); <it>.hasNext();) {
	<type> <name> = (<type>) <it>.next();
	<index>++;
```

Loop over an array

`<loopa type name index expression >` →
```
<type>[] <array> = (<type>) expression;
for (int <index> = 0; <index> < <array>.length; <index>++) {
	<type> <name> = <array>[<index>];
```

Print expression, xml escaped

`<print expression >`

Print expression, as is

`<print unsafe expression >`

Java code

`<java> code </java>`

Include a sub template

`<include name [paramTarget=paramCurrent]*>`

Include a sub template, prepare the params variable for sub template, copying from the current params.

`<includex name [paramTarget=expression]* >`

Same, but accept expressions (and actual variables) instead of param names. Expressions cannot contains spaces.


### caveats

Current javassist does not support full java syntax, instead a j2se 1.4 subset. Avoid using generics and foreach loops in the java code.

Debugging generated bytecode by javassist does not keep track of line numbers.
In the future I can't exclude a javac based version (actually it is excluded because it needs to write a file to the disk to get it compiled).


## License

`repeat` is released under the terms of GNU Lesser General Public License.
